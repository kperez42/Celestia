rules_version = '2';

// Firebase Storage Security Rules for Celestia
// Deploy with: firebase deploy --only storage

service firebase.storage {
  match /b/{bucket}/o {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isValidImageSize() {
      return request.resource.size < 15 * 1024 * 1024; // 15MB max (matches ImageUploadService)
    }

    function isValidImage() {
      return request.resource.contentType.matches('image/.*');
    }

    function isEmailVerified() {
      return request.auth.token.email_verified == true;
    }

    // Admin role check helper (requires custom claims)
    function hasAdminRole() {
      return request.auth.token.admin == true;
    }

    // ============================================================
    // USER PHOTO UPLOADS
    // ============================================================

    // Signup photos - users/{userId}/photos/{fileName}
    // Note: Email verification NOT required since this is during signup
    match /users/{userId}/photos/{fileName} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated()
                   && isOwner(userId)
                   && isValidImageSize()
                   && isValidImage();
      allow delete: if isAuthenticated() && isOwner(userId);
    }

    // Gallery photos - gallery_photos/{userId}/{fileName}
    // Used by EditProfileView for additional photos
    match /gallery_photos/{userId}/{fileName} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated()
                   && isOwner(userId)
                   && isValidImageSize()
                   && isValidImage();
      allow delete: if isAuthenticated() && isOwner(userId);
    }

    // Profile photos - profile_photos/{userId}/{fileName}
    // Used by OfflineManager for queued uploads
    match /profile_photos/{userId}/{fileName} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated()
                   && isOwner(userId)
                   && isValidImageSize()
                   && isValidImage();
      allow delete: if isAuthenticated() && isOwner(userId);
    }

    // Profile images - profile_images/{userId}/{fileName}
    // Used for main profile image
    match /profile_images/{userId}/{fileName} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated()
                   && isOwner(userId)
                   && isValidImageSize()
                   && isValidImage();
      allow delete: if isAuthenticated() && isOwner(userId);
    }

    // ============================================================
    // CHAT & MESSAGING
    // ============================================================

    // Chat images - users can upload to match folders they're part of
    match /chat_images/{matchId}/{fileName} {
      // Simplified: allow any authenticated user to read/write chat images
      // The match validation happens at Firestore level
      allow read: if isAuthenticated();
      allow write: if isAuthenticated()
                   && isValidImageSize()
                   && isValidImage();
    }

    // ============================================================
    // VERIFICATION
    // ============================================================

    // Verification photos - temporary storage for photo verification
    match /verification_photos/{userId}/{fileName} {
      allow read: if isAuthenticated() && (isOwner(userId) || hasAdminRole());
      allow write: if isAuthenticated()
                   && isOwner(userId)
                   && isValidImageSize()
                   && isValidImage();
      // Auto-delete after 7 days (handled by Cloud Function)
    }

    // Manual ID verification uploads (ID photo + selfie for admin review)
    match /verification/{userId}/{fileName} {
      allow read: if isAuthenticated() && (isOwner(userId) || hasAdminRole());
      allow write: if isAuthenticated()
                   && isOwner(userId)
                   && isValidImageSize()
                   && isValidImage();
    }

    // ============================================================
    // ADMIN
    // ============================================================

    // Admin uploads for app assets, marketing materials, etc.
    match /admin/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && hasAdminRole();
    }

    // ============================================================
    // DEFAULT DENY
    // ============================================================

    // Deny all other access - security by default
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
